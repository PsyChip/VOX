(()=>{"use strict";function e(){return e=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)({}).hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},e.apply(null,arguments)}function t(e){const t=new Uint8Array(e);return window.btoa(String.fromCharCode(...t))}function n(e){const t=window.atob(e),n=t.length,o=new Uint8Array(n);for(let e=0;e<n;e++)o[e]=t.charCodeAt(e);return o.buffer}const o=new Map;function a(e,t){return async n=>{const a=o.get(e);if(a)return n.addModule(a);const s=new Blob([t],{type:"application/javascript"}),i=URL.createObjectURL(s);try{return await n.addModule(i),void o.set(e,i)}catch(e){URL.revokeObjectURL(i)}try{const a=`data:application/javascript;base64,${btoa(t)}`;await n.addModule(a),o.set(e,a)}catch(t){throw new Error(`Failed to load the ${e} worklet module. Make sure the browser supports AudioWorklets.`)}}}const s=a("raw-audio-processor",'\nconst BIAS = 0x84;\nconst CLIP = 32635;\nconst encodeTable = [\n  0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,\n  4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,\n  5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,\n  5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n  7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7\n];\n\nfunction encodeSample(sample) {\n  let sign;\n  let exponent;\n  let mantissa;\n  let muLawSample;\n  sign = (sample >> 8) & 0x80;\n  if (sign !== 0) sample = -sample;\n  sample = sample + BIAS;\n  if (sample > CLIP) sample = CLIP;\n  exponent = encodeTable[(sample>>7) & 0xFF];\n  mantissa = (sample >> (exponent+3)) & 0x0F;\n  muLawSample = ~(sign | (exponent << 4) | mantissa);\n  \n  return muLawSample;\n}\n\nclass RawAudioProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n              \n    this.port.onmessage = ({ data }) => {\n      switch (data.type) {\n        case "setFormat":\n          this.isMuted = false;\n          this.buffer = []; // Initialize an empty buffer\n          this.bufferSize = data.sampleRate / 4;\n          this.format = data.format;\n\n          if (globalThis.LibSampleRate && sampleRate !== data.sampleRate) {\n            globalThis.LibSampleRate.create(1, sampleRate, data.sampleRate).then(resampler => {\n              this.resampler = resampler;\n            });\n          }\n          break;\n        case "setMuted":\n          this.isMuted = data.isMuted;\n          break;\n      }\n    };\n  }\n  process(inputs) {\n    if (!this.buffer) {\n      return true;\n    }\n    \n    const input = inputs[0]; // Get the first input node\n    if (input.length > 0) {\n      let channelData = input[0]; // Get the first channel\'s data\n\n      // Resample the audio if necessary\n      if (this.resampler) {\n        channelData = this.resampler.full(channelData);\n      }\n\n      // Add channel data to the buffer\n      this.buffer.push(...channelData);\n      // Get max volume \n      let sum = 0.0;\n      for (let i = 0; i < channelData.length; i++) {\n        sum += channelData[i] * channelData[i];\n      }\n      const maxVolume = Math.sqrt(sum / channelData.length);\n      // Check if buffer size has reached or exceeded the threshold\n      if (this.buffer.length >= this.bufferSize) {\n        const float32Array = this.isMuted \n          ? new Float32Array(this.buffer.length)\n          : new Float32Array(this.buffer);\n\n        let encodedArray = this.format === "ulaw"\n          ? new Uint8Array(float32Array.length)\n          : new Int16Array(float32Array.length);\n\n        // Iterate through the Float32Array and convert each sample to PCM16\n        for (let i = 0; i < float32Array.length; i++) {\n          // Clamp the value to the range [-1, 1]\n          let sample = Math.max(-1, Math.min(1, float32Array[i]));\n\n          // Scale the sample to the range [-32768, 32767]\n          let value = sample < 0 ? sample * 32768 : sample * 32767;\n          if (this.format === "ulaw") {\n            value = encodeSample(Math.round(value));\n          }\n\n          encodedArray[i] = value;\n        }\n\n        // Send the buffered data to the main script\n        this.port.postMessage([encodedArray, maxVolume]);\n\n        // Clear the buffer after sending\n        this.buffer = [];\n      }\n    }\n    return true; // Continue processing\n  }\n}\nregisterProcessor("raw-audio-processor", RawAudioProcessor);\n');function i(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}class r{static async create({sampleRate:e,format:t,preferHeadphonesForIosDevices:n}){let o=null,a=null;try{const l={sampleRate:{ideal:e},echoCancellation:{ideal:!0},noiseSuppression:{ideal:!0}};if(i()&&n){const e=(await window.navigator.mediaDevices.enumerateDevices()).find(e=>"audioinput"===e.kind&&["airpod","headphone","earphone"].find(t=>e.label.toLowerCase().includes(t)));e&&(l.deviceId={ideal:e.deviceId})}const c=navigator.mediaDevices.getSupportedConstraints().sampleRate;o=new window.AudioContext(c?{sampleRate:e}:{});const u=o.createAnalyser();c||await o.audioWorklet.addModule("https://cdn.jsdelivr.net/npm/@alexanderolsen/libsamplerate-js@2.1.2/dist/libsamplerate.worklet.js"),await s(o.audioWorklet),a=await navigator.mediaDevices.getUserMedia({audio:l});const d=o.createMediaStreamSource(a),h=new AudioWorkletNode(o,"raw-audio-processor");return h.port.postMessage({type:"setFormat",format:t,sampleRate:e}),d.connect(u),u.connect(h),await o.resume(),new r(o,u,h,a)}catch(e){var l,c;throw null==(l=a)||l.getTracks().forEach(e=>e.stop()),null==(c=o)||c.close(),e}}constructor(e,t,n,o){this.context=void 0,this.analyser=void 0,this.worklet=void 0,this.inputStream=void 0,this.context=e,this.analyser=t,this.worklet=n,this.inputStream=o}async close(){this.inputStream.getTracks().forEach(e=>e.stop()),await this.context.close()}setMuted(e){this.worklet.port.postMessage({type:"setMuted",isMuted:e})}}const l=a("audio-concat-processor",'\nconst decodeTable = [0,132,396,924,1980,4092,8316,16764];\n\nexport function decodeSample(muLawSample) {\n  let sign;\n  let exponent;\n  let mantissa;\n  let sample;\n  muLawSample = ~muLawSample;\n  sign = (muLawSample & 0x80);\n  exponent = (muLawSample >> 4) & 0x07;\n  mantissa = muLawSample & 0x0F;\n  sample = decodeTable[exponent] + (mantissa << (exponent+3));\n  if (sign !== 0) sample = -sample;\n\n  return sample;\n}\n\nclass AudioConcatProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n    this.buffers = []; // Initialize an empty buffer\n    this.cursor = 0;\n    this.currentBuffer = null;\n    this.wasInterrupted = false;\n    this.finished = false;\n    \n    this.port.onmessage = ({ data }) => {\n      switch (data.type) {\n        case "setFormat":\n          this.format = data.format;\n          break;\n        case "buffer":\n          this.wasInterrupted = false;\n          this.buffers.push(\n            this.format === "ulaw"\n              ? new Uint8Array(data.buffer)\n              : new Int16Array(data.buffer)\n          );\n          break;\n        case "interrupt":\n          this.wasInterrupted = true;\n          break;\n        case "clearInterrupted":\n          if (this.wasInterrupted) {\n            this.wasInterrupted = false;\n            this.buffers = [];\n            this.currentBuffer = null;\n          }\n      }\n    };\n  }\n  process(_, outputs) {\n    let finished = false;\n    const output = outputs[0][0];\n    for (let i = 0; i < output.length; i++) {\n      if (!this.currentBuffer) {\n        if (this.buffers.length === 0) {\n          finished = true;\n          break;\n        }\n        this.currentBuffer = this.buffers.shift();\n        this.cursor = 0;\n      }\n\n      let value = this.currentBuffer[this.cursor];\n      if (this.format === "ulaw") {\n        value = decodeSample(value);\n      }\n      output[i] = value / 32768;\n      this.cursor++;\n\n      if (this.cursor >= this.currentBuffer.length) {\n        this.currentBuffer = null;\n      }\n    }\n\n    if (this.finished !== finished) {\n      this.finished = finished;\n      this.port.postMessage({ type: "process", finished });\n    }\n\n    return true; // Continue processing\n  }\n}\n\nregisterProcessor("audio-concat-processor", AudioConcatProcessor);\n');class c{static async create({sampleRate:e,format:t}){let n=null;try{n=new AudioContext({sampleRate:e});const o=n.createAnalyser(),a=n.createGain();a.connect(o),o.connect(n.destination),await l(n.audioWorklet);const s=new AudioWorkletNode(n,"audio-concat-processor");return s.port.postMessage({type:"setFormat",format:t}),s.connect(a),await n.resume(),new c(n,o,a,s)}catch(e){var o;throw null==(o=n)||o.close(),e}}constructor(e,t,n,o){this.context=void 0,this.analyser=void 0,this.gain=void 0,this.worklet=void 0,this.context=e,this.analyser=t,this.gain=n,this.worklet=o}async close(){await this.context.close()}}function u(e){return!!e.type}class d{static async create(e){let t=null;try{var n;const o=null!=(n=e.origin)?n:"wss://api.elevenlabs.io",a=e.signedUrl?e.signedUrl:o+"/v1/convai/conversation?agent_id="+e.agentId,s=["convai"];e.authorization&&s.push(`bearer.${e.authorization}`),t=new WebSocket(a,s);const i=await new Promise((n,o)=>{t.addEventListener("open",()=>{var n;const o={type:"conversation_initiation_client_data"};var a,s,i,r;e.overrides&&(o.conversation_config_override={agent:{prompt:null==(a=e.overrides.agent)?void 0:a.prompt,first_message:null==(s=e.overrides.agent)?void 0:s.firstMessage,language:null==(i=e.overrides.agent)?void 0:i.language},tts:{voice_id:null==(r=e.overrides.tts)?void 0:r.voiceId}}),e.customLlmExtraBody&&(o.custom_llm_extra_body=e.customLlmExtraBody),e.dynamicVariables&&(o.dynamic_variables=e.dynamicVariables),null==(n=t)||n.send(JSON.stringify(o))},{once:!0}),t.addEventListener("error",e=>{setTimeout(()=>o(e),0)}),t.addEventListener("close",o),t.addEventListener("message",e=>{const t=JSON.parse(e.data);u(t)&&("conversation_initiation_metadata"===t.type?n(t.conversation_initiation_metadata_event):console.warn("First received message is not conversation metadata."))},{once:!0})}),{conversation_id:r,agent_output_audio_format:l,user_input_audio_format:c}=i,p=h(null!=c?c:"pcm_16000"),m=h(l);return new d(t,r,p,m)}catch(e){var o;throw null==(o=t)||o.close(),e}}constructor(e,t,n,o){this.socket=void 0,this.conversationId=void 0,this.inputFormat=void 0,this.outputFormat=void 0,this.queue=[],this.disconnectionDetails=null,this.onDisconnectCallback=null,this.onMessageCallback=null,this.socket=e,this.conversationId=t,this.inputFormat=n,this.outputFormat=o,this.socket.addEventListener("error",e=>{setTimeout(()=>this.disconnect({reason:"error",message:"The connection was closed due to a socket error.",context:e}),0)}),this.socket.addEventListener("close",e=>{this.disconnect(1e3===e.code?{reason:"agent",context:e}:{reason:"error",message:e.reason||"The connection was closed by the server.",context:e})}),this.socket.addEventListener("message",e=>{try{const t=JSON.parse(e.data);if(!u(t))return;this.onMessageCallback?this.onMessageCallback(t):this.queue.push(t)}catch(e){}})}close(){this.socket.close()}sendMessage(e){this.socket.send(JSON.stringify(e))}onMessage(e){this.onMessageCallback=e,this.queue.forEach(e),this.queue=[]}onDisconnect(e){this.onDisconnectCallback=e,this.disconnectionDetails&&e(this.disconnectionDetails)}disconnect(e){var t;this.disconnectionDetails||(this.disconnectionDetails=e,null==(t=this.onDisconnectCallback)||t.call(this,e))}}function h(e){const[t,n]=e.split("_");if(!["pcm","ulaw"].includes(t))throw new Error(`Invalid format: ${e}`);const o=parseInt(n);if(isNaN(o))throw new Error(`Invalid sample rate: ${n}`);return{format:t,sampleRate:o}}const p={clientTools:{}},m={onConnect:()=>{},onDebug:()=>{},onDisconnect:()=>{},onError:()=>{},onMessage:()=>{},onAudio:()=>{},onModeChange:()=>{},onStatusChange:()=>{},onCanSendFeedbackChange:()=>{}};class f{static async startSession(t){var n;const o=e({},p,m,t);o.onStatusChange({status:"connecting"}),o.onCanSendFeedbackChange({canSendFeedback:!1});let a=null,s=null,l=null,u=null,h=null;if(null==(n=t.useWakeLock)||n)try{h=await navigator.wakeLock.request("screen")}catch(e){}try{var g,v;u=await navigator.mediaDevices.getUserMedia({audio:!0});const n=null!=(g=t.connectionDelay)?g:{default:0,android:3e3};let p=n.default;var y;if(/android/i.test(navigator.userAgent))p=null!=(y=n.android)?y:p;else if(i()){var w;p=null!=(w=n.ios)?w:p}return p>0&&await new Promise(e=>setTimeout(e,p)),s=await d.create(t),[a,l]=await Promise.all([r.create(e({},s.inputFormat,{preferHeadphonesForIosDevices:t.preferHeadphonesForIosDevices})),c.create(s.outputFormat)]),null==(v=u)||v.getTracks().forEach(e=>e.stop()),u=null,new f(o,s,a,l,h)}catch(e){var b,k,M,_;o.onStatusChange({status:"disconnected"}),null==(b=u)||b.getTracks().forEach(e=>e.stop()),null==(k=s)||k.close(),await(null==(M=a)?void 0:M.close()),await(null==(_=l)?void 0:_.close());try{var S;await(null==(S=h)?void 0:S.release()),h=null}catch(e){}throw e}}constructor(e,o,a,s,i){var r=this;this.options=void 0,this.connection=void 0,this.input=void 0,this.output=void 0,this.wakeLock=void 0,this.lastInterruptTimestamp=0,this.mode="listening",this.status="connecting",this.inputFrequencyData=void 0,this.outputFrequencyData=void 0,this.volume=1,this.currentEventId=1,this.lastFeedbackEventId=1,this.canSendFeedback=!1,this.endSession=()=>this.endSessionWithDetails({reason:"user"}),this.endSessionWithDetails=async function(e){if("connected"===r.status||"connecting"===r.status){r.updateStatus("disconnecting");try{var t;await(null==(t=r.wakeLock)?void 0:t.release()),r.wakeLock=null}catch(e){}r.connection.close(),await r.input.close(),await r.output.close(),r.updateStatus("disconnected"),r.options.onDisconnect(e)}},this.updateMode=e=>{e!==this.mode&&(this.mode=e,this.options.onModeChange({mode:e}))},this.updateStatus=e=>{e!==this.status&&(this.status=e,this.options.onStatusChange({status:e}))},this.updateCanSendFeedback=()=>{const e=this.currentEventId!==this.lastFeedbackEventId;this.canSendFeedback!==e&&(this.canSendFeedback=e,this.options.onCanSendFeedbackChange({canSendFeedback:e}))},this.onMessage=async function(e){switch(e.type){case"interruption":return e.interruption_event&&(r.lastInterruptTimestamp=e.interruption_event.event_id),void r.fadeOutAudio();case"agent_response":return void r.options.onMessage({source:"ai",message:e.agent_response_event.agent_response});case"user_transcript":return void r.options.onMessage({source:"user",message:e.user_transcription_event.user_transcript});case"internal_tentative_agent_response":return void r.options.onDebug({type:"tentative_agent_response",response:e.tentative_agent_response_internal_event.tentative_agent_response});case"client_tool_call":if(r.options.clientTools.hasOwnProperty(e.client_tool_call.tool_name))try{var t;const n=null!=(t=await r.options.clientTools[e.client_tool_call.tool_name](e.client_tool_call.parameters))?t:"Client tool execution successful.",o="object"==typeof n?JSON.stringify(n):String(n);r.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:o,is_error:!1})}catch(t){r.onError("Client tool execution failed with following error: "+(null==t?void 0:t.message),{clientToolName:e.client_tool_call.tool_name}),r.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:"Client tool execution failed: "+(null==t?void 0:t.message),is_error:!0})}else{if(r.options.onUnhandledClientToolCall)return void r.options.onUnhandledClientToolCall(e.client_tool_call);r.onError(`Client tool with name ${e.client_tool_call.tool_name} is not defined on client`,{clientToolName:e.client_tool_call.tool_name}),r.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:`Client tool with name ${e.client_tool_call.tool_name} is not defined on client`,is_error:!0})}return;case"audio":return void(r.lastInterruptTimestamp<=e.audio_event.event_id&&(r.options.onAudio(e.audio_event.audio_base_64),r.addAudioBase64Chunk(e.audio_event.audio_base_64),r.currentEventId=e.audio_event.event_id,r.updateCanSendFeedback(),r.updateMode("speaking")));case"ping":return void r.connection.sendMessage({type:"pong",event_id:e.ping_event.event_id});default:return void r.options.onDebug(e)}},this.onInputWorkletMessage=e=>{"connected"===this.status&&this.connection.sendMessage({user_audio_chunk:t(e.data[0].buffer)})},this.onOutputWorkletMessage=({data:e})=>{"process"===e.type&&this.updateMode(e.finished?"listening":"speaking")},this.addAudioBase64Chunk=e=>{this.output.gain.gain.value=this.volume,this.output.worklet.port.postMessage({type:"clearInterrupted"}),this.output.worklet.port.postMessage({type:"buffer",buffer:n(e)})},this.fadeOutAudio=()=>{this.updateMode("listening"),this.output.worklet.port.postMessage({type:"interrupt"}),this.output.gain.gain.exponentialRampToValueAtTime(1e-4,this.output.context.currentTime+2),setTimeout(()=>{this.output.gain.gain.value=this.volume,this.output.worklet.port.postMessage({type:"clearInterrupted"})},2e3)},this.onError=(e,t)=>{console.error(e,t),this.options.onError(e,t)},this.calculateVolume=e=>{if(0===e.length)return 0;let t=0;for(let n=0;n<e.length;n++)t+=e[n]/255;return t/=e.length,t<0?0:t>1?1:t},this.getId=()=>this.connection.conversationId,this.isOpen=()=>"connected"===this.status,this.setVolume=({volume:e})=>{this.volume=e},this.setMicMuted=e=>{this.input.setMuted(e)},this.getInputByteFrequencyData=()=>(null!=this.inputFrequencyData||(this.inputFrequencyData=new Uint8Array(this.input.analyser.frequencyBinCount)),this.input.analyser.getByteFrequencyData(this.inputFrequencyData),this.inputFrequencyData),this.getOutputByteFrequencyData=()=>(null!=this.outputFrequencyData||(this.outputFrequencyData=new Uint8Array(this.output.analyser.frequencyBinCount)),this.output.analyser.getByteFrequencyData(this.outputFrequencyData),this.outputFrequencyData),this.getInputVolume=()=>this.calculateVolume(this.getInputByteFrequencyData()),this.getOutputVolume=()=>this.calculateVolume(this.getOutputByteFrequencyData()),this.sendFeedback=e=>{this.canSendFeedback?(this.connection.sendMessage({type:"feedback",score:e?"like":"dislike",event_id:this.currentEventId}),this.lastFeedbackEventId=this.currentEventId,this.updateCanSendFeedback()):console.warn(0===this.lastFeedbackEventId?"Cannot send feedback: the conversation has not started yet.":"Cannot send feedback: feedback has already been sent for the current response.")},this.sendContextualUpdate=e=>{this.connection.sendMessage({type:"contextual_update",text:e})},this.sendUserMessage=e=>{this.connection.sendMessage({type:"user_message",text:e})},this.sendUserActivity=()=>{this.connection.sendMessage({type:"user_activity"})},this.options=e,this.connection=o,this.input=a,this.output=s,this.wakeLock=i,this.options.onConnect({conversationId:o.conversationId}),this.connection.onDisconnect(this.endSessionWithDetails),this.connection.onMessage(this.onMessage),this.input.worklet.port.onmessage=this.onInputWorkletMessage,this.output.worklet.port.onmessage=this.onOutputWorkletMessage,this.updateStatus("connected")}}let g=null;var v,y=new sound("/static/VoiceLeave.ogg"),w=new sound("/static/VoiceJoin.ogg"),b=new sound("/static/VoiceError.ogg"),k=document.getElementById("subtitle");let M=!1,_=!1,S=0,C=null,x=0,I=0,D=!1;const A=document.getElementById("canvas").getContext("2d");let F=A.canvas.width=window.innerWidth,T=A.canvas.height=window.innerHeight;window.onresize=function(){F=A.canvas.width=window.innerWidth,T=A.canvas.height=window.innerHeight};let L,E,P,B,R,q,U=0,O=0,W=!1,V=[];var H=0;let z,$,j="";const N={circleRadius:80,multiplier:40,colorSpeed:10,hueStart:0,glow:8,coef:.09},J=window.AudioContext||window.webkitAudioContext;function G(){if(0===V.length||H>V.length-1)k.innerHTML="";else{k.innerHTML="— "+V[H];var e=90*V[H].length;H++,v=setTimeout(function(){G()},e)}}function K(){const e=document.getElementById("disconnectionBox");e&&e.remove()}async function X(){K(),await Y()}function Q(){document.getElementById("listPanel").classList.remove("show")}async function Y(){try{const e=await async function(){try{const e=await fetch("/api/signed-url/"+function(){const e=(new Date).getHours();return e>=5&&e<12?"morning":e>=12&&e<17?"day":e>=17&&e<21?"evening":"night"}());if(!e.ok)throw new Error("Failed to get signed URL");return await e.json()}catch(e){throw console.error("Error getting signed URL:",e),e}}();console.log(e),g=await f.startSession({signedUrl:e.signedUrl,overrides:{agent:{prompt:{prompt:e.system,tool_ids:["tool_01k0hw6g2hfdfscx17h0v1s4s1","tool_01k0j08qadf76b8yd0y98dq1mm"]},firstMessage:e.firstMessage}},clientTools:{open_link:async e=>{"string"!=typeof e&&(e=e.url||e.href||""),console.log("Opening link:",e);const t=document.createElement("a");return t.href=e,t.target="_blank",t.rel="noopener noreferrer",document.body.appendChild(t),t.click(),document.body.removeChild(t),w.play(),!0}},onConnect:()=>{console.log("Connected"),M=!0,w.play(),K()},onDisconnect:()=>{W=!1,M=!1,console.log("Disconnected"),clearTimeout(v),Z(),k.innerHTML="[agent disconnected]",setTimeout(function(){k.innerHTML=""},1e3),y.play(),function(){K();const e=document.createElement("div");e.id="disconnectionBox",e.style.position="fixed",e.style.bottom="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.background="rgba(33, 33, 33, 1)",e.style.color="#fff",e.style.padding="12px 20px",e.style.borderRadius="8px",e.style.border="0px solid rgba(255, 255, 255, 0.2)",e.style.display="flex",e.style.alignItems="center",e.style.gap="12px",e.style.zIndex="1000",e.style.fontSize="14px",e.style.fontFamily="Jost, system-ui, -apple-system, sans-serif";const t=document.createElement("span");t.textContent="Agent is disconnected";const n=document.createElement("button");n.textContent="Call again",n.style.background="#1b5b01",n.style.color="#fff",n.style.border="none",n.style.padding="6px 12px",n.style.borderRadius="4px",n.style.cursor="pointer",n.style.fontSize="12px",n.onclick=X,e.appendChild(t),e.appendChild(n),document.body.appendChild(e)}()},onError:e=>{console.error("Conversation error:",e),b.play(),Z(),clearTimeout(v),k.innerHTML="[error occurred]",e.reason&&(k.innerHTML="["+e.reason+"]"),M=!1},onModeChange:e=>{console.log(e),"speaking"===e.mode?W=!0:(W=!1,clearTimeout(v),k.innerHTML="")},onMessage:e=>{var t;console.log(e),"ai"===e.source?e.message.includes("\n\n")?function(e){const t=document.getElementById("listPanel"),n=document.getElementById("listContent"),o=e.split("\n").filter(e=>e.trim());let a="",s=!1,i=!1;for(let e of o){if(e.match(/^\d+\.\s*(.+)$/)){s=!0;break}if(e.match(/^[-*•]\s*(.+)$/)){i=!0;break}}if(s){a="<ol>";for(let e of o){const t=e.match(/^\d+\.\s*(.+)$/);t&&(a+=`<li>${t[1].trim()}</li>`)}a+="</ol>"}else if(i){a="<ul>";for(let e of o){const t=e.match(/^[-*•]\s*(.+)$/);t&&(a+=`<li>${t[1].trim()}</li>`)}a+="</ul>"}else{const t=e.indexOf(":\n\n");if(-1!==t){const n=e.substring(t+3).trim().split("\n").filter(e=>e.trim());a="<ul>";for(let e of n)e.trim()&&(a+=`<li>${e.trim()}</li>`);a+="</ul>"}}n.innerHTML=a,t.classList.add("show")}(e.message):(t=e.message,V=t.match(/[^.!?]+[.!?]+/g)||[],H=0,G()):"user"===e.source&&Q()}}),z=g.output.context.createConvolver(),B=g.output.analyser,$=await async function(e=2,t=2,n=!1){const o=g.output.context.sampleRate,a=o*e,s=g.output.context.createBuffer(2,a,o),i=s.getChannelData(0),r=s.getChannelData(1);for(let e=0;e<a;e++){const o=n?a-e:e;i[e]=(2*Math.random()-1)*Math.pow(1-o/a,t),r[e]=(2*Math.random()-1)*Math.pow(1-o/a,t)}return s}(.75,1.25,!1),z.buffer=$;const t=g.output.context.createGain();t.gain.value=.525;const n=g.output.context.createGain();n.gain.value=.875;const o=g.output.analyser.context.destination;g.output.analyser.disconnect(),g.output.analyser.connect(n),g.output.analyser.connect(z),z.connect(t),t.connect(o),n.connect(o),!0===D?(B.fftSize=64,B.smoothingTimeConstant=.25):(B.fftSize=128,B.smoothingTimeConstant=.45),B.maxDecibels=0,B.minDecibels=-100}catch(e){M=!1,console.error("Error starting conversation:",e),alert("Failed to start conversation. Please try again.")}}function Z(){for(let e=0;e<L.length;e++)L[e]=0}function ee(){A.beginPath();const e=A.createLinearGradient(F/2,0,F/2,T);e.addColorStop(0,"hsl("+(N.hueStart+O*N.colorSpeed)+", 35%, 10%"),e.addColorStop(1,"hsl("+(N.hueStart+O*N.colorSpeed)+", 75%, 5%"),A.fillStyle=e,A.fillRect(0,0,F,T),A.closePath()}function te(){ee(),function(){let e=0;var t=10;if(!1===M){const e=512;O+=e/1e5,U+=e/3e5,t=5}else{const e=ne();O+=e/1e6,U+=e/3e6,!0===W?B.getByteFrequencyData(L):(P.getByteFrequencyData(L),function(){if(W)return;P.getByteFrequencyData(L),S=function(e){let t=0,n=0;for(let o=2;o<15;o++)t+=e[o],n++;for(let o=16;o<90;o++)t+=1.2*e[o],n++;return n>0?t/n:0}(L);const e=Date.now();S>15?(C&&(clearTimeout(C),C=null),x++,x>=5&&!_&&(_=!0,console.log("Speech started"),Q()),I=e):_&&S<10?!C&&e-I>300&&(C=setTimeout(()=>{_=!1,x=0,console.log("End of sentence detected"),function(){const e=document.createElement("div");e.style.position="fixed",e.style.bottom="20px",e.style.right="20px",e.style.background="rgba(0,255,0,0.3)",e.style.padding="5px 10px",e.style.borderRadius="5px",e.innerText="End of sentence",document.body.appendChild(e),setTimeout(()=>{e.remove()},1e3)}(),C=null},800)):x=Math.max(0,x-1)}())}const n=noise.perlin2(t,U),o=Math.round(E-E/3),a=ne();for(let t=0;t<o;t++){e+=L[t],e/=o;const s=F/2+(N.circleRadius+a/4/o)*Math.cos(-Math.PI/2+2*Math.PI*t/o+n),i=T/2+(N.circleRadius+a/4/o)*Math.sin(-Math.PI/2+2*Math.PI*t/o+n),r=F/2+(N.circleRadius+a/4/o+e*N.multiplier)*Math.cos(-Math.PI/2+2*Math.PI*t/o+n),l=T/2+(N.circleRadius+a/4/o+e*N.multiplier)*Math.sin(-Math.PI/2+2*Math.PI*t/o+n),c=F/2+(N.circleRadius+a/4/o+Math.pow(e*N.multiplier*N.coef,2))*Math.cos(-Math.PI/2+2*Math.PI*t/o+n),u=T/2+(N.circleRadius+a/4/o+Math.pow(e*N.multiplier*N.coef,2))*Math.sin(-Math.PI/2+2*Math.PI*t/o+n),d=10*noise.simplex2(i/100,O);A.beginPath(),A.lineCap="round",A.shadowBlur=N.glow,A.lineWidth=1;const h=_?230:35;!0===W?(A.strokeStyle="hsla(128, 50%, "+(20+Math.pow(3*e,2))+"%, 100%)",A.shadowColor="hsla(128, 50%, "+(20+Math.pow(3*e,2))+"%, 100%)"):(A.strokeStyle="hsla("+h+", 10%, "+(10+Math.pow(3*e,2))+"%, 100%)",A.shadowColor="hsla("+h+", 10%, "+(10+Math.pow(3*e,2))+"%, 100%)"),A.moveTo(s+d,i+d),A.lineTo(r+d,l+d),A.stroke(),A.closePath(),A.beginPath(),A.lineCap="round",A.shadowBlur=N.glow,A.lineWidth=4,!1===M?(A.strokeStyle="hsla(180, 20%, "+(30+Math.pow(3*e,2))+"%, 100%)",A.shadowColor="hsla(180, 20%, "+(30+Math.pow(3*e,2))+"%, 100%)"):!0===W?(A.strokeStyle="hsla(128, 50%, "+(30+Math.pow(3*e,2))+"%, 100%)",A.shadowColor="hsla(128, 50%, "+(30+Math.pow(3*e,2))+"%, 100%)"):(A.strokeStyle="hsla("+h+", 50%, "+(50+Math.pow(3*e,2))+"%, 100%)",A.shadowColor="hsla("+h+", 50%, "+(50+Math.pow(3*e,2))+"%, 100%)"),A.moveTo(s+d,i+d),A.lineTo(c+d,u+d),A.stroke(),A.closePath()}W||(A.beginPath(),A.fillStyle=_?"rgba(200, 32, 16, 0.5)":"rgba(235, 235, 235, 0.3)",A.fillRect(20,T-30,Math.min(3*S,200),15),A.strokeStyle="#fff",A.lineWidth=1,A.strokeRect(20,T-30,200,15),A.beginPath(),A.strokeStyle="rgba(255, 255, 255, 0.5)",A.lineWidth=1,A.moveTo(65,T-30),A.lineTo(65,T-15),A.stroke(),A.closePath())}(),requestAnimationFrame(te)}function ne(){let e=0;for(let t=0;t<L.length;t++)e+=L[t];return e}J?(function(){const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),t=navigator.deviceMemory&&navigator.deviceMemory<8;(e||t)&&(D=!0,console.log("Low performance mode enabled")),window.location.search.includes("lowperf=true")&&(D=!0),window.location.search.includes("lowperf=false")&&(D=!1)}(),!0===D&&(N.glow=0,N.multiplier=15,N.coef=.07),navigator.mediaDevices.getUserMedia({audio:!0}).then(function(e){const t=e.getAudioTracks()[0].getSettings().deviceId;return navigator.mediaDevices.enumerateDevices().then(n=>{const o=n.find(e=>e.deviceId===t);if(j=(o?o.label:"Unknown").toString(),""!==j&&!0===function(e){const t=["Stereo Mix","What U Hear","Loopback","VB-Audio Virtual Cable","VB-Audio VoiceMeeter","Virtual Audio Cable","BlackHole","Soundflower","Jack Audio Connection Kit","ASIO4ALL","Rogue Amoeba Loopback","Dante Virtual Soundcard","Sunflower"];for(var n=0;n<t.length;n++)if(e===t[n]||e.indexOf(t[n])>-1||t[n].indexOf(e)>-1)return!0;return!1}(j))return M=!1,void(k.innerHTML="[no microphone detected]");console.log(e),function(e){window.persistAudioStream=e,R=new J,q=R.createMediaStreamSource(e),P=R.createAnalyser(),!0===D?(P.fftSize=64,P.smoothingTimeConstant=.25):(P.fftSize=256,P.smoothingTimeConstant=.6),P.maxDecibels=0,P.minDecibels=-100,q.connect(P),E=P.frequencyBinCount,L=new Uint8Array(E),ee(),te(),async function(){await Y()}()}(e)})}).catch(function(e){console.log(e),M=!1,k.innerHTML="[error occured]"})):console.log("No Audio")})();